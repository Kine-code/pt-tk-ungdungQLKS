CREATE DATABASE QUANLYKHACHSAN_NHOM1;
GO
USE QUANLYKHACHSAN_NHOM1;
GO

CREATE TABLE TBL_NHANVIEN(
	MANV VARCHAR (5) PRIMARY KEY,
	HOTEN NVARCHAR(30),
	NGAYSINH DATE,
	GIOITINH NVARCHAR(3),
	CCCD VARCHAR(15),
	SDT CHAR(12),
)  

CREATE TABLE TBL_KHACHHANG(
	MAKH INT  PRIMARY KEY,
	TENKH NVARCHAR (30),
	CCCD VARCHAR(15),
	SDT CHAR(12),
)

CREATE TABLE TBL_PHONG(
	SOPHONG VARCHAR(5) PRIMARY KEY,
	GIAPHONG INT,
	TRANGTHAI NVARCHAR (20),
)

CREATE TABLE TBL_DATPHONG(
	MADATPHONG INT PRIMARY KEY,	
	SOPHONG VARCHAR (5) FOREIGN KEY REFERENCES TBL_PHONG(SOPHONG),
	NGAYDEN DATE,
	NGAYTRADUKIEN DATE,
	MAKH INT FOREIGN KEY REFERENCES TBL_KHACHHANG(MAKH),
	MANV VARCHAR (5) FOREIGN KEY REFERENCES TBL_NHANVIEN(MANV),
)

CREATE TABLE TBL_TRAPHONG(
	MADATPHONG INT  FOREIGN KEY REFERENCES TBL_DATPHONG(MADATPHONG),
	NGAYTRA DATE,
	SONGAYO INT,
	MANV VARCHAR (5) FOREIGN KEY REFERENCES TBL_NHANVIEN(MANV),
)
CREATE TABLE TBL_HOADON(
	MAHD VARCHAR (10)  PRIMARY KEY,
	MADATPHONG INT FOREIGN KEY REFERENCES TBL_DATPHONG(MADATPHONG),
	--MANV VARCHAR(5)FOREIGN KEY REFERENCES TBL_NHANVIEN(MANV),
	--SOPHONG VARCHAR (5) FOREIGN KEY REFERENCES TBL_PHONG(SOPHONG),
	--MAKH INT FOREIGN KEY REFERENCES TBL_KHACHHANG(MAKH),
	--CCCD VARCHAR(15),
	--SDT CHAR(12),
	--NGAYDEN DATETIME,
	--NGAYTRA DATETIME,
	--TONGTIEN NUMERIC,
)

INSERT INTO TBL_NHANVIEN
VALUES
	('NV01','Đinh Trong Huy','1981-04-18','Nam','0012002123','0912022113'),
	('NV02','Đào Mạnh Huy' ,'1986-02-27','Nam','0012012346','0916598724'),
	('NV03','Lê Thu Huyền','1985-06-09','Nữ','0012012347','0831249125'),
	('NV04','Nguyễn Ngọc Huyền','1982-10-24','Nữ','0012012348','0357199126'),
	('NV05','Phạm Thị Huyền','1979-09-11','Nữ','0012012349','0912047217');

INSERT INTO TBL_PHONG
VALUES
	('101', 500, N'phòng  trống' ),
	('102', 500, N'phòng  trống' ),
	('103', 500, N'phòng  trống' ),
	('104', 500, N'phòng  trống' ),

	('201', 500, N'phòng  trống' ),
	('202', 500, N'phòng  trống' ),
	('203', 500, N'phòng  trống' ),
	('204', 500, N'phòng  trống' ),
	('205', 500, N'phòng  trống' ),
	('206', 500, N'phòng  trống' ),
	('207', 500, N'phòng  trống' ),

	('301', 500, N'phòng  trống' ),
	('302', 500, N'phòng  trống' ),
	('303', 500, N'phòng  trống' ),
	('304', 500, N'phòng  trống' ), 
	('305', 500, N'phòng  trống' ),
	('306', 500, N'phòng  trống' ),
	('307', 500, N'phòng  trống' );
	

INSERT INTO TBL_KHACHHANG(MAKH,TENKH,CCCD,SDT)
VALUES
(01,'NGUYEN VAN A',202012666,0365368754),
(02,'NGUYEN THI B',202503666,0365553454),
(03,'TRAN VAN C',202566456,0360218754),
(04,'VU THI D',202566656,0365558031),
(05,'DUONG CONG K',20256464,0365469784);


INSERT INTO TBL_DATPHONG (MADATPHONG,SOPHONG,NGAYDEN,NGAYTRADUKIEN,MAKH,MANV)
VALUES
(1,'101','2023-02-02','2023-02-06',01,'NV01'),
(2,'102','2023-02-05','2023-02-10',02,'NV02'),
(3,'103','2023-02-20','2023-02-22',03,'NV03'),
(4,'104','2023-02-15','2023-02-19',04,'NV04'),
(5,'201','2023-02-08','2023-02-11',05,'NV02');

INSERT INTO TBL_TRAPHONG (MADATPHONG, NGAYTRA,MANV)
VALUES
(1,'2023-02-06','NV01'),
(2,'2023-02-10','NV02'),
(3,'2023-02-22','NV03'),
(4,'2023-02-20','NV04'),
(5,'2023-02-11','NV02');






SELECT * FROM TBL_TRAPHONG INNER JOIN TBL_DATPHONG ON TBL_DATPHONG.MADATPHONG = TBL_TRAPHONG.MADATPHONG
--INSERT INTO TBL_HOADON(MAHD,MANV,SOPHONG,MAKH,CCCD,SDT,NGAYDEN,NGAYTRA)
--VALUES
--('01','NV01','101',1,202012666,0365368754,'2023-02-02','2023-02-06'),
--('02','NV02','102',2,202503666,0365553454,'2023-02-05','2023-02-10'),
--('03','NV03','103',3,202566456,0360218754,'2023-02-20','2023-02-22'),
--('04','NV04','104',4,202566656,0365558031,'2023-02-15','2023-02-20'),
--('05','NV02','201',5,20256464,0365469784,'2023-02-08','2023-02-11');

INSERT INTO TBL_HOADON(MAHD, MADATPHONG)
VALUES 
('HD01', 1),
('HD02', 2),
('HD03', 3),
('HD04', 4),
('HD05', 5);

UPDATE TBL_PHONG
SET TRANGTHAI = N'đang ở'
WHERE SOPHONG = '101';
UPDATE TBL_PHONG
SET TRANGTHAI = N'đang ở'
WHERE SOPHONG = '102';
UPDATE TBL_PHONG
SET TRANGTHAI = N'đang ở'
WHERE SOPHONG = '103';
UPDATE TBL_PHONG
SET TRANGTHAI = N'đang ở'
WHERE SOPHONG = '104';
UPDATE TBL_PHONG
SET TRANGTHAI = N'đang ở'
WHERE SOPHONG = '201';
SELECT *FROM TBL_KHACHHANG
 --DAT PHONG
SELECT TBL_KHACHHANG.MAKH,TBL_DATPHONG.MANV,TBL_PHONG.TRANGTHAI ,TBL_DATPHONG.MADATPHONG,TBL_DATPHONG.SOPHONG,TBL_DATPHONG.NGAYDEN,TBL_DATPHONG.NGAYTRADUKIEN
FROM TBL_DATPHONG,TBL_KHACHHANG,TBL_PHONG,TBL_NHANVIEN
WHERE TBL_DATPHONG.MAKH= TBL_KHACHHANG.MAKH AND TBL_DATPHONG.MANV= TBL_NHANVIEN.MANV AND TBL_DATPHONG.SOPHONG = TBL_PHONG.SOPHONG
-- TIM PHONG TRONG
SELECT SOPHONG , TRANGTHAI FROM TBL_PHONG 
WHERE TRANGTHAI = N'phòng  trống'
--
SELECT * FROM TBL_KHACHHANG
SELECT * FROM TBL_DATPHONG INNER JOIN TBL_TRAPHONG ON TBL_DATPHONG.MADATPHONG = TBL_TRAPHONG.MADATPHONG
 INNER JOIN TBL_KHACHHANG  ON TBL_KHACHHANG.MAKH = TBL_DATPHONG.MAKH

--TINHS TIEN TU DONG
  SELECT  TBL_DATPHONG.MADATPHONG, TBL_KHACHHANG.TENKH, TBL_DATPHONG.SOPHONG,   TBL_DATPHONG.NGAYDEN, TBL_TRAPHONG.NGAYTRA, DATEDIFF(day, NGAYDEN, NGAYTRA) AS NGAYO , DATEDIFF(day, NGAYDEN, NGAYTRA)*500 AS TONGTIEN
FROM TBL_KHACHHANG INNER JOIN TBL_DATPHONG ON TBL_KHACHHANG.MAKH = TBL_DATPHONG.MAKH 
INNER JOIN TBL_TRAPHONG ON TBL_DATPHONG.MADATPHONG = TBL_TRAPHONG.MADATPHONG
GROUP BY TENKH,TBL_DATPHONG.MADATPHONG,NGAYDEN,NGAYTRA, SOPHONG 
----CHO BIET MAKH, TENKH, TONG TIEN CUA KHACH VA SAP XEP TANG DAN
--SELECT TBL_KHACHHANG.MAKH, TBL_KHACHHANG.TENKH,TBL_HOADON.TONGTIEN
--FROM TBL_KHACHHANG, TBL_HOADON
--WHERE TBL_KHACHHANG.MAKH =TBL_HOADON.MAKH
--ORDER BY TONGTIEN ASC
--CHO BIET MADATPHONG, SOPHONG,DUOC DAT TU 02-02-2023 DEN 11-02-2023

	SELECT * FROM TBL_KHACHHANG
	SELECT*FROM TBL_DATPHONG
SELECT TBL_DATPHONG.MADATPHONG, TBL_PHONG.SOPHONG
FROM TBL_DATPHONG, TBL_PHONG
WHERE TBL_DATPHONG.SOPHONG =TBL_PHONG.SOPHONG AND NGAYDEN BETWEEN  CONVERT(DATETIME,'2023-02-02',101) AND CONVERT(DATETIME,'2023-02-11',101)
SELECT * FROM TBL_DATPHONG
----LAY RA 2 KHACH HANG CO TONG GIA TRI HOA DON LON NHAT
--SELECT TOP 2 TBL_KHACHHANG.MAKH, TBL_HOADON.MAHD,TBL_KHACHHANG.TENKH, TBL_HOADON.TONGTIEN AS TT
--FROM TBL_KHACHHANG AS TBL_KHACHHANG, TBL_HOADON AS TBL_HOADON
--WHERE TBL_KHACHHANG.MAKH = TBL_HOADON.MAKH
--ORDER BY TT DESC 
----LAY RA 1 KHACH HANG CO TONG GIA TRI HOA DON LON NHAT
--SELECT TOP 1 TBL_KHACHHANG.MAKH, TBL_HOADON.MAHD,TBL_KHACHHANG.TENKH, TBL_HOADON.TONGTIEN AS TT
--FROM TBL_KHACHHANG AS TBL_KHACHHANG, TBL_HOADON AS TBL_HOADON
--WHERE TBL_KHACHHANG.MAKH = TBL_HOADON.MAKH
--ORDER BY TT 
---- CHO BIET GIA TRI TONG TIEN CAO NHAT VA THAP NHAT
--SELECT MAX(TBL_HOADON.TONGTIEN), MIN(TBL_HOADON.TONGTIEN)
--FROM TBL_HOADON
---- TINH DOANH THU TRONG NAM 2023
--SELECT sum(TBL_HOADON.TONGTIEN)
--FROM TBL_HOADON
--WHERE YEAR(TBL_HOADON.NGAYTRA) = 2023
---- TINH GIA TRI TRUNG BINH DOANHTHU
--SELECT AVG(TBL_HOADON.TONGTIEN)
--FROM TBL_HOADON
--WHERE YEAR(TBL_HOADON.NGAYTRA) = 2023


